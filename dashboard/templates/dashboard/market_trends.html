{% extends 'base.html' %}
{% block title %}Market Analysis | SugarQube{% endblock %}

{% block content %}
<div class="max-w-full mx-auto">
        <div class="grid grid-cols-12 gap-6">
            
            <div class="col-span-10">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-1">PRICE CHART</h3>
                            <h2 class="text-2xl font-bold text-indigo-900">Sugar Price Market Trend</h2>
                        </div>
                        <button id="exportData" class="px-3 py-1 bg-white-50 text-white-700 rounded text-sm hover:bg-white-100 transition-colors border border-white-0">
                            
                        </button>
                    </div>
                    
                    <div id="container" style="height: 700px; min-width: 310px"></div>
                    
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        <span>OPEN ACCOUNT TO UNLOCK CHART SETTINGS ►</span>
                    </div>
                </div>
            </div>
            
            <div class="col-span-2 space-y-4">
                
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 text-center">
                    <div class="text-sm text-gray-500 mb-1">PRICE</div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">{{ latest_price|floatformat:2 }}</div>
                    <div class="flex items-center justify-center">
                        <span class="text-sm {% if daily_change >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                            {% if daily_change > 0 %}▲{% elif daily_change < 0 %}▼{% endif %}
                            {{ daily_change_percent|floatformat:2 }}%
                        </span>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="space-y-2">
                        <button id="indicatorsBtn" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm hover:bg-blue-100 transition-colors border border-blue-200 w-full">
                            Indicators
                        </button>
                        <button id="drawingToolsBtn" class="px-4 py-2 bg-green-50 text-green-700 rounded text-sm hover:bg-green-100 transition-colors border border-green-200 w-full">
                            Drawing Tools
                        </button>
                    </div>
                    
                    <div id="indicatorsDropdown" class="hidden mt-3 p-3 bg-gray-50 rounded border">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="toggleMA" title="Moving Averages" class="px-2 py-1 bg-white text-blue-700 rounded text-xs hover:bg-blue-50 transition-colors border text-center">
                                MA
                            </button>
                            <button id="toggleBB" title="Bollinger Bands" class="px-2 py-1 bg-white text-green-700 rounded text-xs hover:bg-green-50 transition-colors border text-center">
                                BB
                            </button>
                            <button id="toggleRSI" title="Relative Strength Index" class="px-2 py-1 bg-white text-yellow-700 rounded text-xs hover:bg-yellow-50 transition-colors border text-center">
                                RSI
                            </button>
                            <button id="toggleMACD" title="Moving Average Convergence/Divergence" class="px-2 py-1 bg-white text-purple-700 rounded text-xs hover:bg-purple-50 transition-colors border text-center">
                                MACD
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">ANNUAL LOW:</span>
                                <span class="font-semibold text-gray-900 text-sm">{{ annual_min|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">ANNUAL HIGH:</span>
                                <span class="font-semibold text-gray-900 text-sm">{{ annual_max|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">CHANGE</span>
                                <span class="font-semibold text-sm">
                                    {{ daily_change|floatformat:2 }}
                                </span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-600">CHANGE %</span>
                                <span class="font-semibold text-sm">
                                    {{ daily_change_percent|floatformat:2 }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/stocktools/gui.css">

<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
<script src="https://code.highcharts.com/stock/indicators/indicators-all.js"></script>
<script src="https://code.highcharts.com/stock/modules/stock-tools.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const rawData = {{ chart_data|safe }};
    
    if (!rawData || rawData.length === 0) {
        document.getElementById('container').innerHTML = 
            '<div class="flex items-center justify-center h-full text-gray-500"><p>No data available</p></div>';
        return;
    }
    
    let chart;
    let movingAveragesVisible = false;
    let bollingerBandsVisible = false;
    let rsiVisible = false;
    let macdVisible = false;
    let drawingToolsVisible = false;
    
    function createChart() {
        const currentPrice = rawData[rawData.length - 1][1];
        
        chart = Highcharts.stockChart('container', {
            chart: { 
                backgroundColor: '#ffffff',
                zoomType: 'xy',
                style: { fontFamily: 'Inter, sans-serif' }
            },
            credits: { enabled: false },
            
            rangeSelector: {
                selected: 10,
                buttons: [
                    { type: 'month', count: 1, text: '1M' },
                    { type: 'month', count: 3, text: '3M' },
                    { type: 'month', count: 6, text: '6M' },
                    { type: 'ytd', text: 'YTD' },
                    { type: 'year', count: 1, text: '1Y' },
                    { type: 'year', count: 5, text: '5Y' },
                    { type: 'all', text: 'MAX' }
                ],
                buttonTheme: {
                    fill: '#f3f4f6',
                    stroke: '#d1d5db',
                    'stroke-width': 1,
                    style: { color: '#374151' },
                    states: {
                        hover: { fill: '#e5e7eb' },
                        select: { fill: '#10B981', style: { color: 'white' } }
                    }
                }
            },
            
            title: { text: null },
            navigator: { enabled: false },
            scrollbar: { enabled: false },
            
            xAxis: { 
                type: "datetime",
                gridLineColor: "#f1f5f9",
                lineColor: "#e2e8f0",
                tickColor: "#e2e8f0",
                labels: { style: { color: '#64748b' } }
            },
            
            yAxis: [{
                title: { text: null },
                labels: { 
                    format: '{value:,.2f}',
                    style: { color: '#64748b' },
                    align: 'left',
                    x: 10
                },
                gridLineColor: "#f1f5f9",
                height: '60%',
                plotLines: [{
                    value: currentPrice,
                    color: '#10B981',
                    width: 1,
                    zIndex: 4,
                    dashStyle: 'dot',
                    label: {
                        text: currentPrice.toFixed(2),
                        align: 'right',
                        x: 70,
                        style: { color: 'white' },
                        formatter: function() {
                           return '<div style="background-color:#10B981; padding: 4px 8px; border-radius: 4px; font-size:12px;">' + this.options.label.text + '</div>';
                        },
                        useHTML: true
                    }
                }]
            }, {
                title: { text: null },
                labels: { 
                    align: 'left',
                    x: 10
                },
                top: '65%',
                height: '35%',
                offset: 0,
                gridLineColor: "#f1f5f9"
            }, {
                title: { text: null },
                labels: {
                   enabled: false
                },
                top: '65%',
                height: '35%',
                offset: 0,
                gridLineColor: "#f1f5f9"
            }],
            
            tooltip: { 
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderWidth: 1,
                borderColor: '#e2e8f0',
                borderRadius: 8,
                shadow: true,
                shared: true,
                useHTML: true,
                headerFormat: '<div style="padding: 8px;"><span style="font-size: 12px; color: #334155; font-weight: 600;">{point.x:%d %b \'%y}</span><br/>',
                pointFormat: '<span style="color:{point.color}; font-size: 16px; font-weight: bold;">\u25CF</span> ' +
                            '<span style="color: #475569;">Price:</span> ' +
                            '<b style="color: #1e293b;">{point.y:,.2f}</b><br/>',
                footerFormat: '</div>',
                valueDecimals: 2
            },
            
            stockTools: {
                gui: { enabled: false }
            },
            
            series: [{
                name: 'Sugar Price',
                data: rawData,
                type: 'line',
                id: 'main-series',
                color: '#10B981',
                lineWidth: 2
            }],
            
            exporting: { enabled: true },
            legend: { enabled: false }
        });
        
        return chart;
    }
    
    // Functions to toggle indicators
    function toggleSeries(seriesId, isVisible, button, activeClass, createFunc, yAxisIndex, title) {
        const series = chart.get(seriesId);
        if (series) {
            series.remove();
            button.classList.remove(activeClass);
            if (yAxisIndex !== undefined) {
                chart.yAxis[yAxisIndex].setTitle({ text: null });
            }
            return false;
        } else {
            createFunc();
            button.classList.add(activeClass);
            if (yAxisIndex !== undefined) {
                chart.yAxis[yAxisIndex].setTitle({ text: title });
            }
            return true;
        }
    }

    function toggleMovingAverages() {
        if (!chart) return;
        const button = document.getElementById('toggleMA');
        if (movingAveragesVisible) {
            ['sma-20', 'sma-50'].forEach(id => { if(chart.get(id)) chart.get(id).remove(); });
            button.classList.remove('bg-blue-100');
            movingAveragesVisible = false;
        } else {
            chart.addSeries({ id: 'sma-20', linkedTo: 'main-series', type: 'sma', params: { period: 20 }, name: 'SMA 20', color: '#f59e0b', dashStyle: 'Dash' });
            chart.addSeries({ id: 'sma-50', linkedTo: 'main-series', type: 'sma', params: { period: 50 }, name: 'SMA 50', color: '#ef4444', dashStyle: 'Dot' });
            button.classList.add('bg-blue-100');
            movingAveragesVisible = true;
        }
    }

    function toggleBollingerBands() {
        bollingerBandsVisible = toggleSeries('bb', bollingerBandsVisible, document.getElementById('toggleBB'), 'bg-green-100', () => {
            chart.addSeries({ id: 'bb', linkedTo: 'main-series', type: 'bb', name: 'Bollinger Bands' });
        });
    }

    function toggleRSI() {
        rsiVisible = toggleSeries('rsi', rsiVisible, document.getElementById('toggleRSI'), 'bg-yellow-100', () => {
            chart.addSeries({ id: 'rsi', linkedTo: 'main-series', type: 'rsi', name: 'RSI', yAxis: 1, params: { period: 14 } });
        }, 1, 'RSI');
    }

    function toggleMACD() {
        macdVisible = toggleSeries('macd', macdVisible, document.getElementById('toggleMACD'), 'bg-purple-100', () => {
            chart.addSeries({ id: 'macd', linkedTo: 'main-series', type: 'macd', name: 'MACD', yAxis: 2 });
        }, 2, 'MACD');
    }

    // Event Listeners
    document.getElementById('indicatorsBtn').addEventListener('click', () => {
        document.getElementById('indicatorsDropdown').classList.toggle('hidden');
    });
    
    document.getElementById('drawingToolsBtn').addEventListener('click', () => {
        drawingToolsVisible = !drawingToolsVisible;
        chart.update({ stockTools: { gui: { enabled: drawingToolsVisible } } });
        document.getElementById('drawingToolsBtn').classList.toggle('bg-green-100', drawingToolsVisible);
    });
    
    document.getElementById('toggleMA').addEventListener('click', toggleMovingAverages);
    document.getElementById('toggleBB').addEventListener('click', toggleBollingerBands);
    document.getElementById('toggleRSI').addEventListener('click', toggleRSI);
    document.getElementById('toggleMACD').addEventListener('click', toggleMACD);
    
    document.getElementById('exportData').addEventListener('click', () => chart && chart.exportChart());
    
    createChart();
});
</script>
{% endblock %}