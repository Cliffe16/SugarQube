{% extends 'base.html' %}
{% block title %}Market Analysis | SugarQube{% endblock %}
{% block content %}
<div class="max-w-full mx-auto">

    {% if user.is_authenticated and not user.is_verified_buyer %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
        <p class="font-bold">Account Verification Required</p>
        <p>Your account is not yet verified. To access the trading marketplace, please upload your KYC documents for approval.</p>
        <a href="{% url 'verification' %}" class="mt-2 inline-block bg-yellow-500 text-white font-bold py-2 px-4 rounded hover:bg-yellow-600">
            Upload Documents Now
        </a>
    </div>
    {% endif %}

    <div class="grid grid-cols-12 gap-6">

        <div class="col-span-10">
            <div class="card p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">PRICE CHART</h3>
                        <h2 class="text-2xl font-bold text-indigo-900">Sugar Market Price Trend</h2>
                    </div>
                </div>

                <div style="position: relative;">
                    <div class="absolute top-0 left-[350px] z-10 mt-2.5 ml-10">
                        <div class="flex items-center space-x-2">
                                <span class="border-l border-gray-300 h-6 mx-2"></span>
                            <label for="timezone" class="text-sm font-medium text-gray-500"></label>
                            <select id="timezone" class="block w-48 pl-1 pr-1 py-1 text-xs bg-white border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 rounded-md appearance-none">
                                <option value="Africa/Nairobi" data-label="EAT (Nairobi)" selected>EAT (Nairobi)</option>
                                <option value="UTC" data-label="UTC">UTC</option>
                                <option value="Europe/London" data-label="GMT (London)">GMT (London)</option>
                                <option value="America/New_York" data-label="EST (New York)">EST (New York)</option>
                                <option value="Asia/Tokyo" data-label="JST (Tokyo)">JST (Tokyo)</option>
                            </select>
                        </div>
                    </div>

                    <div id="container" style="height: 700px; min-width: 310px;" tabindex="0"></div>
                </div>
            </div>
        </div>
        <div class="col-span-2 space-y-4">

            <div class="card p-6 text-center">
                <div class="text-sm text-gray-500 mb-1">PRICE</div>
                <div class="text-3xl font-bold text-gray-900 mb-2" data-kes-price="{{ latest_price }}" id="latest-price">
                    <span class="currency-symbol">KES</span> <span class="price-figure">{{ latest_price|floatformat:2 }}</span>
                </div>
                <div class="flex items-center justify-center">
                    <span class="text-sm font-semibold" id="price-change"></span>
                </div>
            </div>
            <div class="card p-6 text-center">
                <div class="text-sm text-gray-500 mb-1">EXCHANGE RATE</div>
                <div class="text-3xl font-bold text-gray-900 mb-2">{{ EXCHANGE_RATE_USD|floatformat:2 }}</div>
                <div class="text-sm text-gray-500">KES/USD</div>
            </div>
            <div class="card p-4">
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-600">ANNUAL HIGH:</span>
                            <span class="font-semibold text-gray-900 text-sm text-right" data-kes-price="{{ annual_max }}" id="annual-high">
                                <span class="currency-symbol">KES</span> <span class="price-figure">{{ annual_max|floatformat:2 }}</span>
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-600">ANNUAL LOW:</span>
                            <span class="font-semibold text-gray-900 text-sm text-right" data-kes-price="{{ annual_min }}" id="annual-low">
                                <span class="currency-symbol">KES</span> <span class="price-figure">{{ annual_min|floatformat:2 }}</span>
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-600">CHANGE</span>
                            <span class="font-semibold text-sm text-right" data-kes-price="{{ daily_change }}" id="daily-change">
                                <span class="currency-symbol">KES</span> <span class="price-figure">{{ daily_change|floatformat:2 }}</span>
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-600">CHANGE %</span>
                            <span class="font-semibold text-sm text-right" id="change-percent">{{ daily_change_percent|floatformat:2 }}%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card p-4 text-center" id="indicators-card">
              <div class="text-sm text-gray-500 mb-1">LATEST INDICATORS</div>
              <div class="space-y-3" id="indicators-content">
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">RSI (14):</span><span class="font-semibold text-gray-900 text-sm" id="rsi14">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">EMA (30):</span><span class="font-semibold text-gray-900 text-sm" id="ema30">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">Bollinger Upper (20,2):</span><span class="font-semibold text-gray-900 text-sm" id="bb-upper">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">Bollinger Lower (20,2):</span><span class="font-semibold text-gray-900 text-sm" id="bb-lower">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">ROC (12):</span><span class="font-semibold text-gray-900 text-sm" id="roc12">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">CCI (20):</span><span class="font-semibold text-gray-900 text-sm" id="cci20">—</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-gray-600">Momentum (10):</span><span class="font-semibold text-gray-900 text-sm" id="mom10">—</span></div>
              </div>
            </div>
        </div>

{% endblock %}
{% block scripts %}
<link rel="stylesheet" type="text/css" href="https://unpkg.com/highcharts@10.3.3/css/stocktools/gui.css">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/highcharts@10.3.3/css/annotations/popup.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>

<script src="https://unpkg.com/highcharts@10.3.3/highstock.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/indicators.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/sma.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/ema.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/bollinger-bands.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/wma.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/momentum.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/roc.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/cci.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/cmo.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/trix.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/indicators/linear-regression.js"></script>

<script src="https://unpkg.com/highcharts@10.3.3/modules/annotations.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/modules/annotations-advanced.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/modules/price-indicator.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/modules/full-screen.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/modules/stock-tools.js"></script>
<script src="https://unpkg.com/highcharts@10.3.3/modules/exporting.js"></script>

<script>
// --- indicator utilities -------------------------------------------------
function extractPricesAsNumbers(data) {
    if (!Array.isArray(data)) return [];
    return data.map(p => parseFloat(p[1]));
}

// returns ema series (same length as input, first entries may be null until seed)
function emaSeries(arr, period) {
    const n = arr.length;
    if (n === 0 || n < period) return [];
    const k = 2 / (period + 1);
    const out = new Array(n).fill(null);
    // seed at index (period-1) with SMA of first period
    let seedSum = 0;
    for (let i = 0; i < period; i++) seedSum += arr[i];
    out[period - 1] = seedSum / period;
    for (let i = period; i < n; i++) {
        out[i] = arr[i] * k + out[i - 1] * (1 - k);
    }
    return out;
}

// RSI using Wilder smoothing (returns last RSI value)
function computeRSI(arr, period = 14) {
    if (!Array.isArray(arr) || arr.length < period + 1) return null;
    const deltas = new Array(arr.length - 1);
    for (let i = 1; i < arr.length; i++) deltas[i - 1] = arr[i] - arr[i - 1];

    let gain = 0, loss = 0;
    for (let i = 0; i < period; i++) {
        const d = deltas[i];
        if (d > 0) gain += d; else loss += Math.abs(d);
    }
    let avgGain = gain / period;
    let avgLoss = loss / period;

    for (let i = period; i < deltas.length; i++) {
        const d = deltas[i];
        let g = d > 0 ? d : 0;
        let l = d < 0 ? Math.abs(d) : 0;
        avgGain = (avgGain * (period - 1) + g) / period;
        avgLoss = (avgLoss * (period - 1) + l) / period;
    }
    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    const rsi = 100 - (100 / (1 + rs));
    return rsi;
}

// Bollinger Bands (last values) - simple: period and k (e.g. 20,2)
function bollingerBands(arr, period = 20, k = 2) {
    if (!Array.isArray(arr) || arr.length < period) return { upper: null, lower: null, mid: null };
    const slice = arr.slice(arr.length - period);
    const mean = slice.reduce((a, b) => a + b, 0) / period;
    const variance = slice.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / period;
    const std = Math.sqrt(variance);
    return { upper: mean + k * std, lower: mean - k * std, mid: mean };
}

// Rate of Change (percentage) - ROC(n)
function roc(arr, period = 12) {
    const n = arr.length;
    if (n <= period) return null;
    const prev = arr[n - 1 - period];
    if (!prev || prev === 0) return null;
    return ((arr[n - 1] - prev) / prev) * 100;
}

// Momentum = difference between current and n periods ago
function momentum(arr, period = 10) {
    const n = arr.length;
    if (n <= period) return null;
    return arr[n - 1] - arr[n - 1 - period];
}

// Commodity Channel Index (CCI) using close as typical price approximation
function cci(arr, period = 20) {
    const n = arr.length;
    if (n < period) return null;
    const slice = arr.slice(n - period);
    const sma = slice.reduce((a, b) => a + b, 0) / period;
    const meanDev = slice.reduce((s, v) => s + Math.abs(v - sma), 0) / period;
    if (meanDev === 0) return null;
    const tp = arr[n - 1];
    return (tp - sma) / (0.015 * meanDev);
}

// --- populateIndicatorCard (main) --------------------------------------
function populateIndicatorCard(data) {
    try {
        const prices = extractPricesAsNumbers(data);
        const rsi14 = computeRSI(prices, 14);
        const ema30Series = emaSeries(prices, 30);
        const ema30 = ema30Series.length ? ema30Series[ema30Series.length - 1] : null;
        const bb = bollingerBands(prices, 20, 2);
        const roc12 = roc(prices, 12);
        const cci20 = cci(prices, 20);
        const mom10 = momentum(prices, 10);

        const fmt = (v, digits=2) => (v == null || Number.isNaN(v)) ? '—' : Number(v).toFixed(digits);

        document.getElementById('rsi14').textContent = rsi14 != null ? fmt(rsi14, 2) : '—';
        document.getElementById('ema30').textContent = ema30 != null ? fmt(ema30, 2) : '—';
        document.getElementById('bb-upper').textContent = bb.upper != null ? fmt(bb.upper, 2) : '—';
        document.getElementById('bb-lower').textContent = bb.lower != null ? fmt(bb.lower, 2) : '—';
        document.getElementById('roc12').textContent = roc12 != null ? fmt(roc12, 2) + '%' : '—';
        document.getElementById('cci20').textContent = cci20 != null ? fmt(cci20, 2) : '—';
        document.getElementById('mom10').textContent = mom10 != null ? fmt(mom10, 2) : '—';
    } catch (err) {
        console.warn('Failed to populate indicators', err);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const rawData = {{ chart_data|safe }};
    const timezoneSelect = document.getElementById('timezone');
    const predictionData = {{ prediction_data|default:"[]"|safe }};
    const currencySelector = document.getElementById('currency-selector');
    const exchangeRate = {{ EXCHANGE_RATE_USD|default:1.0 }};
    let chart;

    function getConvertedData(currency) {
        if (!Array.isArray(rawData)) return [];
        if (currency === 'USD' && exchangeRate && exchangeRate !== 0) {
            return rawData.map(point => [
                Number(point[0]), 
                parseFloat((parseFloat(point[1]) / exchangeRate).toFixed(2))
            ]);
        }
        return rawData.map(point => [Number(point[0]), parseFloat(point[1])]);
    }

    function updateTimezoneOptions() {
        if (!timezoneSelect) return;
        const options = timezoneSelect.options;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            const timezone = option.value;
            const label = option.getAttribute('data-label');
            const timeString = moment().tz(timezone).format('MMM D, h:mm A');
            option.text = `${label} (${timeString})`;
        }
    }

    function ensureContainerInteractivity(container) {
        try {
            container.style.touchAction = container.style.touchAction || 'manipulation';
            container.style.userSelect = container.style.userSelect || 'none';
        } catch (e) { /* ignore */ }
    }

    Highcharts.setOptions({
        lang: {
            stockTools: {
                toggleLR: 'Toggle Prediction'
            }
        }
    });

    async function updateAccuracyMetrics(model) {
        try {
            const endpoint = new URL('dashboard/api/predict/', window.location.origin);
            endpoint.searchParams.set('model', model);
            const resp = await fetch(endpoint.toString(), { method: 'GET', credentials: 'same-origin' });
            if (!resp.ok) {
                return;
            }
            const json = await resp.json();
            if (json.metrics) {
                const metrics = json.metrics;
                const bestModelEl = document.getElementById('metric-best-model');
                const r2El = document.getElementById('metric-r2');
                const maeEl = document.getElementById('metric-mae');
                const mapeEl = document.getElementById('metric-mape');

                if (bestModelEl) bestModelEl.textContent = metrics.best_model || '-';
                if (r2El) r2El.textContent = metrics.r2 != null ? metrics.r2.toFixed(2) : '-';
                if (maeEl) maeEl.textContent = metrics.mae != null ? metrics.mae.toFixed(2) : '-';
                if (mapeEl) mapeEl.textContent = metrics.mape != null ? metrics.mape.toFixed(2) + '%' : '-';
            }
        } catch (err) {
            console.error('Failed to update accuracy metrics', err);
        }
    }

    function createChart(timezone) {
        const selectedCurrency = currencySelector ? currencySelector.value : 'KES';
        const chartData = getConvertedData(selectedCurrency);

        if (!chartData || chartData.length === 0) {
            document.getElementById('container').innerHTML =
                '<div class="flex items-center justify-center h-full text-gray-500"><p>No data available</p></div>';
            return;
        }
        
        populateIndicatorCard(chartData);

        const currentPrice = chartData[chartData.length - 1][1];

        if (chart) {
            try { chart.destroy(); } catch (e) { console.warn(e); }
        }

        chart = Highcharts.stockChart('container', {
            chart: {
            backgroundColor: '#ffffff',
            style: { fontFamily: 'Inter, sans-serif' },
            spacingRight: 30,
            events: {
                load: function () {
                    ensureContainerInteractivity(this.container);
                }
            }
            },

            rangeSelector: {
                selected: 10,
                buttons: [
                    { type: 'month', count: 1, text: '1M' },
                    { type: 'month', count: 3, text: '3M' },
                    { type: 'month', count: 6, text: '6M' },
                    { type: 'ytd', text: 'YTD' },
                    { type: 'year', count: 1, text: '1Y' },
                    { type: 'year', count: 5, text: '5Y' },
                    { type: 'all', text: 'MAX' }
                ],
                buttonTheme: {
                    fill: 'none',
                    stroke: 'none',
                    'stroke-width': 0,
                    style: { color: '#6B7280', fontWeight: '500' },
                    states: {
                        hover: { fill: '#F9FAFB', style: { color: '#1F2937' } },
                        select: { fill: 'none', style: { color: '#1E3A8A', fontWeight: '700' } }
                    }
                },
                inputStyle: { backgroundColor: '#F9FAFB', borderColor: '#D1D5DB' }
            },
            title: {
                text: ''
            },
            xAxis: {
                gridLineWidth: 1,
                gridLineColor: "#f1f5f9",
                crosshair: {
                    enabled: true,
                    snap: true,
                    dashStyle: 'dot',
                    color: 'gray',
                    label: {
                        enabled: true,
                        format: '{value:%d %b \'%y}',
                        backgroundColor: '#047857',
                        borderColor: '#047857',
                        style: { color: 'white', fontWeight: 'bold' }
                    }
                }
            },
            yAxis: [{
                labels: {
                    format: '{value:,.2f}',
                    align: 'left',
                    x: 10
                },
                gridLineColor: "#f1f5f9",
                height: '80%',
                resize: {
                    enabled: true
                },
                crosshair: {
                    enabled: true,
                    snap: true,
                    dashStyle: 'dot',
                    color: 'gray',
                    label: {
                        enabled: true,
                        formatter: function (value) {
                            return value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        },
                        backgroundColor: '#047857',
                        borderColor: '#047857',
                        style: { color: 'white', fontWeight: 'bold' }
                    }
                }
            }, {
                labels: {
                    align: 'left'
                },
                top: '80%',
                height: '20%',
                offset: 0
            }],
            tooltip: {
                enabled: false 
            },
            navigator: { 
                enabled: false 
            },
            stockTools: {
                gui: {
                    enabled: true,
                    iconsURL: 'https://code.highcharts.com/10.3.3/gfx/stock-icons/',
                    buttons: [
                      'toggleLR', 'separator', 'indicators', 'separator',
                      'simpleShapes', 'lines', 'crookedLines', 'measure', 'advanced',
                      'toggleAnnotations', 'separator', 'verticalLabels', 'flags', 'separator',
                      'zoomChange', 'fullScreen', 'typeChange', 'separator', 'currentPriceIndicator', 'saveChart'
                    ],
                    definitions: {
                        toggleLR: {
                            className: 'highcharts-toggle-lr',
                            symbol: 'series-line.svg'
                        }
                    }
                }
            },
            navigation: {
                bindings: {
                    toggleLR: {
                        className: 'highcharts-toggle-lr',
                        init: function (button) {
                            const chart = this.chart;
                            const predId = 'prediction-series-1';
                            const existing = chart.get(predId);
                            if (existing) {
                                existing.remove();
                                button.classList.remove('highcharts-active');
                                return;
                            }
                            if (!document.getElementById('hc-forecast-popup-style')) {
                                const style = document.createElement('style');
                                style.id = 'hc-forecast-popup-style';
                                style.textContent = `
                                .highcharts-popup-forecast {
                                    position: absolute; background: #fff; border: 1px solid #e6e6e6; border-radius: 8px;
                                    box-shadow: 0 8px 24px rgba(16,24,40,0.08); padding: 12px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                                    z-index: 2000; min-width: 240px; font-size: 13px;
                                }
                                .highcharts-popup-forecast label { display:block; margin-bottom:6px; color:#111827; font-weight:600; font-size:13px; }
                                .highcharts-popup-forecast select, .highcharts-popup-forecast input[type="number"] { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #d1d5db; background:#fff; }
                                .highcharts-popup-forecast .hc-row { margin-top:8px; }
                                .highcharts-popup-forecast .hc-forecast-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
                                .highcharts-popup-forecast .hc-forecast-actions button { padding:7px 11px; border-radius:6px; border:1px solid transparent; background:#f3f4f6; cursor:pointer; }
                                .highcharts-popup-forecast .hc-forecast-actions .apply { background:#0f766e; color:white; border-color:transparent; }
                                .hc-small-checkbox { transform: translateY(2px); margin-right:6px; }
                                `;
                                document.head.appendChild(style);
                            }
                            const existingPopup = chart.container.parentNode.querySelector('.highcharts-popup-forecast');
                            if (existingPopup) existingPopup.remove();
                            const popup = document.createElement('div');
                            popup.className = 'highcharts-popup-forecast';
                            popup.innerHTML = `
                            <label for="hc-forecast-select">Forecast window (days)</label>
                            <select id="hc-forecast-select" aria-label="Forecast window"><option value="7">7</option><option value="14" selected>14</option><option value="30">30</option></select>
                            <div class="hc-row"><label for="hc-model-select">Model (hint)</label><select id="hc-model-select" aria-label="Model hint"><option value="auto" selected>Auto (best model)</option><option value="arima">ARIMA</option><option value="ets">ETS</option><option value="ma">Moving Average</option></select></div>
                            <div class="hc-row" style="margin-top:12px; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                                <label style="margin-bottom:8px;">Model Accuracy (Backtest)</label>
                                <div id="accuracy-metrics-container" style="font-size:12px; color:#4b5563;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span>Best Model:</span>
                                        <span id="metric-best-model" style="font-weight:600; color:#111827;">-</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span>R-squared:</span>
                                        <span id="metric-r2" style="font-weight:600; color:#111827;">-</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span>MAE:</span>
                                        <span id="metric-mae" style="font-weight:600; color:#111827;">-</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>MAPE:</span>
                                        <span id="metric-mape" style="font-weight:600; color:#111827;">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="hc-row" style="margin-top:8px;"><label><input id="hc-ci-checkbox" class="hc-small-checkbox" type="checkbox" /> Show confidence intervals (if available)</label></div>
                            <div class="hc-forecast-actions"><button type="button" class="cancel">Cancel</button><button type="button" class="apply">Apply</button></div>
                            `;
                            try {
                                const btnRect = button.getBoundingClientRect();
                                const chartRect = chart.container.getBoundingClientRect();
                                const top = Math.max(6, btnRect.bottom - chartRect.top + 6);
                                let left = btnRect.left - chartRect.left;
                                const popupWidthEstimate = 260;
                                if (left + popupWidthEstimate > chartRect.width) {
                                    left = Math.max(6, chartRect.width - popupWidthEstimate - 6);
                                }
                                popup.style.top = `${top}px`;
                                popup.style.left = `${left}px`;
                            } catch (err) {}
                            chart.container.parentNode.appendChild(popup);

                            const modelSelect = popup.querySelector('#hc-model-select');
                            modelSelect.addEventListener('change', (e) => {
                                updateAccuracyMetrics(e.target.value);
                            });
                            updateAccuracyMetrics(modelSelect.value);

                            const removePopup = () => {
                                popup.remove();
                                button.classList.remove('highcharts-active');
                                document.removeEventListener('click', docClickHandler);
                            };
                            popup.querySelector('.cancel').addEventListener('click', removePopup);
                            popup.querySelector('.apply').addEventListener('click', async function () {
                                const selDays = popup.querySelector('#hc-forecast-select').value;
                                const selModel = popup.querySelector('#hc-model-select').value;
                                const showCi = popup.querySelector('#hc-ci-checkbox').checked ? '1' : '0';
                                const days = parseInt(selDays, 10) || 14;
                                const applyBtn = popup.querySelector('.apply');
                                applyBtn.disabled = true;
                                applyBtn.textContent = 'Loading...';
                                try {
                                    const endpoint = new URL('dashboard/api/predict/', window.location.origin);
                                    endpoint.searchParams.set('forecast_days', days);
                                    endpoint.searchParams.set('model', selModel);
                                    endpoint.searchParams.set('ci', showCi);
                                    const resp = await fetch(endpoint.toString(), { method: 'GET', credentials: 'same-origin' });
                                    if (!resp.ok) {
                                        const txt = await resp.text();
                                        alert('Prediction API error: ' + resp.status + ' ' + txt);
                                        applyBtn.disabled = false;
                                        applyBtn.textContent = 'Apply';
                                        return;
                                    }
                                    const json = await resp.json();
                                    const pred = json.prediction || [];
                                    if (!Array.isArray(pred) || pred.length === 0) {
                                        alert('No prediction returned for the selected window.');
                                        applyBtn.disabled = false;
                                        applyBtn.textContent = 'Apply';
                                        return;
                                    }
                                    const existingSeries = chart.get(predId);
                                    if (existingSeries) {
                                        existingSeries.remove();
                                    }
                                    chart.addSeries({
                                        id: predId, name: 'Prediction (' + json.forecast_days + 'd)', type: 'line', data: pred,
                                        dashStyle: 'ShortDash', marker: { enabled: false }, zIndex: 6, tooltip: { valueDecimals: 2 }
                                    }, false);
                                    if (json.ci_lower && json.ci_upper && Array.isArray(json.ci_lower) && Array.isArray(json.ci_upper)) {
                                        const ciId = predId + '-ci';
                                        const prevCI = chart.get(ciId);
                                        if (prevCI) prevCI.remove();
                                        const ar = [];
                                        for (let i = 0; i < json.ci_lower.length; i++) {
                                            const low = json.ci_lower[i] && json.ci_lower[i][1];
                                            const high = json.ci_upper[i] && json.ci_upper[i][1];
                                            const ts = json.ci_lower[i] && json.ci_lower[i][0];
                                            if (ts != null && low != null && high != null) {
                                                ar.push([ts, low, high]);
                                            }
                                        }
                                        if (ar.length > 0) {
                                            chart.addSeries({
                                                id: ciId, name: 'Prediction CI', type: 'arearange', data: ar,
                                                linkedTo: predId, fillOpacity: 0.15, zIndex: 5, marker: { enabled: false }
                                            }, false);
                                        }
                                    }
                                    chart.redraw();
                                    if (json.metrics) {
                                        console.info('Prediction metrics:', json.metrics);
                                    }
                                    removePopup();
                                } catch (err) {
                                    console.error('Prediction fetch error', err);
                                    alert('Failed to fetch prediction: ' + err.message);
                                    applyBtn.disabled = false;
                                    applyBtn.textContent = 'Apply';
                                }
                            });
                            const docClickHandler = function (e) {
                                if (!popup.contains(e.target) && e.target !== button) {
                                    removePopup();
                                }
                            };
                            setTimeout(() => document.addEventListener('click', docClickHandler), 0);
                            button.classList.remove('highcharts-active');
                        }
                    }
                },
            },
            plotOptions: {
                series: {
                    showInLegend: true,
                    dataGrouping: {
                        enabled: false
                    },
                    marker: {
                        enabled: true,
                        radius: 0,
                        states: {
                            hover: {
                                enabled: true,
                                radius: 5,
                                fillColor: '#ffffff',
                                lineColor: '#047857',
                                lineWidth: 2
                            }
                        }
                    }
                }
            },
            series: [{
                type: 'line',
                id: 'main-series',
                name: `Sugar Price (${selectedCurrency})`,
                data: chartData,
                color: '#047857',
            }]
    })
};
    const forecastSelector = document.getElementById('forecast-selector');
    if(forecastSelector) {
        forecastSelector.addEventListener('change', function() {
            const days = this.value;
            window.location.href = `?forecast_days=${days}`;
        });
    }

    updateTimezoneOptions();
    createChart(timezoneSelect.value);

    setInterval(updateTimezoneOptions, 60000);

    if (timezoneSelect) {
        timezoneSelect.addEventListener('change', function() {
            createChart(this.value);
        });
    }

    if (currencySelector) {
        currencySelector.addEventListener('change', function() {
            createChart(timezoneSelect.value);
        });
    }
    
    const dailyChange = {{ daily_change|default:0 }};
    const dailyChangePercent = {{ daily_change_percent|default:0 }};
    const changeElement = document.getElementById('price-change');
    
    if (changeElement) {
        let changeSymbol = '';
        let changeClass = '';
        if (dailyChange > 0) {
            changeSymbol = '▲';
            changeClass = 'text-green-600';
        } else if (dailyChange < 0) {
            changeSymbol = '▼';
            changeClass = 'text-red-600';
        } else {
            changeSymbol = '';
            changeClass = 'text-gray-500';
        }
        changeElement.textContent = `${changeSymbol} ${Math.abs(dailyChangePercent).toFixed(2)}%`.trim();
        changeElement.className = `text-sm ${changeClass} font-semibold`;
    }
});
</script>
{% endblock %}